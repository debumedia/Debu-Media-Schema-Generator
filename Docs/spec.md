# Plugin Spec: AI JSON-LD Generator for WordPress

## 1. Goal

Create a WordPress plugin that:

- Adds a metabox to the Page edit screen (and optionally Posts later).
- On button click, sends the page content (plus context) to an LLM provider (DeepSeek first).
- Receives LLM-generated JSON-LD tailored to the page.
- Saves the JSON-LD to post meta.
- Outputs the JSON-LD on the frontend (preferred: in `<head>` as a script tag; optional: after content).

**Notes:**
- Best practice is outputting JSON-LD in the head, not injecting visible markup after content. You can still support "after content" as an option if you want.

---

## 2. Scope v1

### Supported content types
- `page` only (v1)
- Extensible to `post` and custom post types later.

### Provider
- DeepSeek only (v1), but build a provider interface so adding OpenAI/Anthropic/etc is plug-and-play later.

### Output
- Save JSON-LD in post meta.
- Render JSON-LD via:
  - **Default:** `wp_head`
  - **Optional toggle:** append after content via `the_content` filter.

---

## 3. Architecture Overview

### Plugin name / slug
- **Name:** "AI JSON-LD Generator"
- **Slug:** `ai-jsonld-generator`
- **Text domain:** `ai-jsonld-generator`

### Key components

**Admin UI**
- Settings page (provider selection, API key, model settings, output mode).
- Metabox with "Generate JSON-LD" button + preview + status/errors.

**Backend logic**
- Provider abstraction layer.
- Prompt builder.
- JSON validation + sanitation.
- Post meta save.

**Frontend output**
- `wp_head` hook and/or `the_content` injection.

---

## 4. Data Storage

### Options (site-wide)

Store in `wp_options` (single serialized array):

```php
$default_settings = [
    // Provider
    'provider'                   => 'deepseek',
    'deepseek_api_key'          => '',  // Encrypted
    'deepseek_model'            => 'deepseek-chat',

    // Generation
    'temperature'               => 0.2,
    'max_tokens'                => 1200,
    'max_content_chars'         => 8000,

    // Output
    'output_location'           => 'head',  // head | after_content
    'enabled_post_types'        => ['page'],

    // Behavior
    'auto_regenerate_on_update' => false,
    'skip_if_schema_exists'     => false,

    // Cleanup
    'delete_data_on_uninstall'  => false,

    // Debug
    'debug_logging'             => false,

    // Internal
    'settings_version'          => '1.0',
];
```

### API Key Encryption Protocol

1. **Encryption method:**
   - Algorithm: AES-256-CBC
   - Key derivation: `hash('sha256', wp_salt('auth') . 'ai_jsonld_key')`
   - IV: First 16 bytes of `hash('sha256', wp_salt('secure_auth'))`

2. **Storage flow:**
```php
function encrypt_api_key($plain_key) {
    $key = hash('sha256', wp_salt('auth') . 'ai_jsonld_key', true);
    $iv = substr(hash('sha256', wp_salt('secure_auth'), true), 0, 16);
    $encrypted = openssl_encrypt($plain_key, 'aes-256-cbc', $key, 0, $iv);
    return base64_encode($encrypted);
}
```

3. **Retrieval flow:**
```php
function decrypt_api_key($encrypted_key) {
    $key = hash('sha256', wp_salt('auth') . 'ai_jsonld_key', true);
    $iv = substr(hash('sha256', wp_salt('secure_auth'), true), 0, 16);
    return openssl_decrypt(base64_decode($encrypted_key), 'aes-256-cbc', $key, 0, $iv);
}
```

4. **Fallback:**
   - If openssl extension unavailable, store with `sanitize_text_field` only
   - Log warning to debug log: "OpenSSL not available - API key stored unencrypted"
   - Display admin notice recommending openssl installation

5. **Display:**
   - Never show full key in UI
   - Show: first 4 chars + "••••••••" + last 4 chars
   - Example: `sk-a1••••••••z9x2`

### Post meta (per page)

```
_ai_jsonld_schema                 # The generated JSON-LD string
_ai_jsonld_schema_last_generated  # Unix timestamp
_ai_jsonld_schema_status          # ok | error
_ai_jsonld_schema_error           # Last error message
_ai_jsonld_schema_hash            # Content hash for cache validation
_ai_jsonld_type_hint              # User's preferred schema type
_ai_jsonld_detected_type          # Actual type generated by LLM
```

### Cache Strategy

1. **Hash generation:**
```php
function generate_content_hash($post_id, $settings) {
    $post = get_post($post_id);

    $hash_input = json_encode([
        'content' => $post->post_content,
        'title' => $post->post_title,
        'excerpt' => $post->post_excerpt,
        'modified' => $post->post_modified,
        'settings_version' => $settings['settings_version'] ?? '1.0',
        'max_content_chars' => $settings['max_content_chars'] ?? 8000,
        'type_hint' => get_post_meta($post_id, '_ai_jsonld_type_hint', true) ?: 'auto'
    ]);

    return hash('sha256', $hash_input);
}
```

2. **Settings version:**
   - Increment when prompt templates or generation logic changes
   - Changing `settings_version` invalidates all caches

3. **Cache check logic:**
```php
function should_regenerate($post_id, $settings, $force = false) {
    if ($force) {
        return true;
    }

    $existing_schema = get_post_meta($post_id, '_ai_jsonld_schema', true);
    if (empty($existing_schema)) {
        return true;
    }

    $stored_hash = get_post_meta($post_id, '_ai_jsonld_schema_hash', true);
    $current_hash = generate_content_hash($post_id, $settings);

    if ($stored_hash !== $current_hash) {
        return true;
    }

    return false;
}
```

4. **Metabox UI cache indicators:**
   - If hash matches: "Schema is current"
   - If hash differs: "⚠️ Content has changed since last generation"
   - Show last generated timestamp

5. **Auto-regenerate option:**
```php
if ($settings['auto_regenerate_on_update'] && should_regenerate($post_id, $settings)) {
    wp_schedule_single_event(time(), 'ai_jsonld_regenerate', [$post_id]);
}
```

---

## 5. Admin Settings Page

### Location
WP Admin menu: **Settings → "AI JSON-LD Generator"**

### Fields

**Provider**
- Dropdown: DeepSeek (v1)
- Placeholder for future providers.

**API Key**
- Input: password field
- Save masked.
- Button: "Test connection"
  - Sends a lightweight request to provider.
  - Stores result transient and displays success/failure.

**Model / generation config**
- Model name (text field)
- Temperature (0–1 slider/number)
- Max tokens
- Max content characters (default: 8000)

**Output settings**
- Output location: Head (recommended) vs After content
- Post types enabled (multi-select checkboxes)
- Skip output if existing JSON-LD detected

**Data Cleanup**
- Delete all generated schemas on uninstall (checkbox)

**Permissions**
- Info text: requires `edit_posts` and `manage_options` to change settings.

**Debug**
- Toggle debug logging to WP debug log.

### Nonces / capability
- All settings updates require `manage_options`.
- Use Settings API (`register_setting`, `add_settings_section`, `add_settings_field`).

---

## 6. Edit Screen Metabox

### Placement
- `add_meta_box` on page edit screen.
- Context: `normal` (preferred for preview).

### UI Elements

**Button:** "Generate JSON-LD"

**Status area:**
- Idle / Generating / Success / Error
- Cache status: "Schema is current" or "⚠️ Content has changed"
- Last generated timestamp

**Preview panel:**
- Read-only textarea showing generated JSON-LD
- "Copy to clipboard"
- "Validate JSON" (client-side quick check)

**Schema Type Selector:**
```html
<label>Schema type hint:</label>
<select name="ai_jsonld_type_hint">
    <option value="auto">Auto-detect (recommended)</option>
    <option value="Article">Article</option>
    <option value="WebPage">WebPage</option>
    <option value="Service">Service</option>
    <option value="LocalBusiness">LocalBusiness</option>
    <option value="FAQPage">FAQPage</option>
    <option value="Product">Product</option>
    <option value="Organization">Organization</option>
    <option value="Person">Person</option>
    <option value="Event">Event</option>
    <option value="HowTo">HowTo</option>
</select>
```

**Controls:**
- Checkbox: "Force regenerate (ignore cache)"
- Optional: "Include featured image data"

### Behavior

On click:
1. JS sends AJAX request to backend with:
   - `post_id`
   - `force` flag
   - `type_hint`
2. Disable button while running
3. Show spinner/progress state
4. Display cooldown timer if rate limited

---

## 7. Backend Generation Flow

### Endpoint

Use WP AJAX:
- Action: `wp_ajax_ai_jsonld_generate`
- Capability: user must be able to `edit_post` for that post.
- Nonce required.

### 7.1 Content Preparation

Before sending to LLM, content must be prepared:

**Settings:**
- `max_content_chars` (int, default: 8000)

**Preparation steps:**
1. Strip HTML tags: `wp_strip_all_tags($content)`
2. Decode HTML entities: `html_entity_decode($content, ENT_QUOTES, 'UTF-8')`
3. Normalize whitespace: `preg_replace('/\s+/', ' ', $content)`
4. Trim: `trim($content)`

**Truncation logic:**
```php
function truncate_content($content, $max_chars = 8000) {
    if (mb_strlen($content) <= $max_chars) {
        return ['content' => $content, 'truncated' => false];
    }

    $truncated = mb_substr($content, 0, $max_chars);
    $last_period = mb_strrpos($truncated, '. ');
    $last_question = mb_strrpos($truncated, '? ');
    $last_exclaim = mb_strrpos($truncated, '! ');

    $break_point = max($last_period, $last_question, $last_exclaim);

    if ($break_point > $max_chars * 0.7) {
        $truncated = mb_substr($content, 0, $break_point + 1);
    }

    return [
        'content' => $truncated,
        'truncated' => true,
        'original_length' => mb_strlen($content)
    ];
}
```

**Prompt inclusion:**
- If truncated, append: `"[Content truncated: showing {$truncated_length} of {$original_length} characters]"`

**UI feedback:**
- If content > max_content_chars, show notice: "Content will be truncated to {max_content_chars} characters for generation."

### 7.2 Rate Limiting and Retry Strategy

**Retry configuration:**
- `max_retries`: 3
- `base_delay`: 1000ms
- `max_delay`: 10000ms
- `backoff_multiplier`: 2

**Retry logic:**
```php
function make_api_request_with_retry($provider, $payload, $settings) {
    $max_retries = 3;
    $delay = 1000;

    for ($attempt = 1; $attempt <= $max_retries; $attempt++) {
        $response = $provider->generate_schema($payload, $settings);

        if ($response['success']) {
            return $response;
        }

        $status_code = $response['status_code'] ?? 0;
        $retryable = in_array($status_code, [429, 500, 502, 503, 504]);

        if (!$retryable || $attempt === $max_retries) {
            return $response;
        }

        if (isset($response['headers']['retry-after'])) {
            $delay = intval($response['headers']['retry-after']) * 1000;
        }

        usleep($delay * 1000);
        $delay = min($delay * 2, 10000);
    }

    return $response;
}
```

**Per-post cooldown:**
- Transient key: `ai_jsonld_cooldown_{$post_id}`
- Cooldown duration: 30 seconds

**Global rate limit tracking:**
- Transient: `ai_jsonld_rate_limit_until`
- If 429 received with Retry-After, set transient with that timestamp

### 7.3 Prompt Templates

**System Prompt:**
```
You are a schema.org JSON-LD generator for web pages.

STRICT REQUIREMENTS:
1. Output ONLY valid JSON. No markdown code fences, no explanations, no commentary.
2. Every object must include "@context": "https://schema.org"
3. Use appropriate schema.org types based on the content.
4. NEVER invent or hallucinate information. If data is not provided, omit that field entirely.
5. For URLs, only use URLs explicitly provided in the input.
6. For dates, only use dates explicitly provided.
7. For contact information, only include if explicitly provided.

OUTPUT FORMAT:
- Single schema object: {"@context": "https://schema.org", "@type": "...", ...}
- Multiple schemas: Use @graph format: {"@context": "https://schema.org", "@graph": [...]}

SCHEMA TYPE SELECTION:
- Article: Blog posts, news articles, editorial content
- WebPage: Generic informational pages
- Service: Pages describing services offered
- LocalBusiness: Business location/contact pages
- FAQPage: ONLY if content contains clear Question/Answer pairs
- Product: Product description pages
- HowTo: Step-by-step instruction content
- Event: Event announcements with dates/locations

Remember: Accuracy over completeness. Omit uncertain fields rather than guess.
```

**User Message Template:**
```
Generate JSON-LD schema for the following page:

PAGE DATA:
{
  "title": "{post_title}",
  "url": "{permalink}",
  "pageType": "{post_type}",
  "content": "{prepared_content}",
  "excerpt": "{excerpt_or_null}",
  "author": "{author_display_name}",
  "datePublished": "{post_date_iso8601}",
  "dateModified": "{post_modified_iso8601}",
  "featuredImage": {
    "url": "{featured_image_url_or_null}",
    "alt": "{featured_image_alt_or_null}",
    "width": {width_or_null},
    "height": {height_or_null}
  },
  "categories": ["{category_names}"],
  "tags": ["{tag_names}"]
}

SITE DATA:
{
  "name": "{site_name}",
  "url": "{site_url}",
  "description": "{site_tagline}"
}

{type_hint_instruction_if_applicable}

Generate the JSON-LD now:
```

**Type Hint Instruction (if not 'auto'):**
```
PREFERRED SCHEMA TYPE: {type_hint}
Use this schema type if the content supports it. If the content clearly does not match this type, choose the most appropriate alternative.
```

**Payload Builder:**
```php
function build_prompt_payload($post_id, $settings) {
    $post = get_post($post_id);

    $content_result = truncate_content(
        wp_strip_all_tags($post->post_content),
        $settings['max_content_chars'] ?? 8000
    );

    $featured_image = null;
    $thumbnail_id = get_post_thumbnail_id($post_id);
    if ($thumbnail_id) {
        $image_data = wp_get_attachment_image_src($thumbnail_id, 'full');
        $featured_image = [
            'url' => $image_data[0] ?? null,
            'alt' => get_post_meta($thumbnail_id, '_wp_attachment_image_alt', true) ?: null,
            'width' => $image_data[1] ?? null,
            'height' => $image_data[2] ?? null
        ];
    }

    return [
        'page' => [
            'title' => get_the_title($post_id),
            'url' => get_permalink($post_id),
            'pageType' => $post->post_type,
            'content' => $content_result['content'],
            'contentTruncated' => $content_result['truncated'],
            'excerpt' => $post->post_excerpt ?: null,
            'author' => get_the_author_meta('display_name', $post->post_author),
            'datePublished' => get_the_date('c', $post_id),
            'dateModified' => get_the_modified_date('c', $post_id),
            'featuredImage' => $featured_image,
            'categories' => wp_get_post_categories($post_id, ['fields' => 'names']),
            'tags' => wp_get_post_tags($post_id, ['fields' => 'names'])
        ],
        'site' => [
            'name' => get_bloginfo('name'),
            'url' => home_url(),
            'description' => get_bloginfo('description')
        ],
        'typeHint' => get_post_meta($post_id, '_ai_jsonld_type_hint', true) ?: 'auto'
    ];
}
```

### Input extracted for prompt

Collect:
- Post title
- Post type
- Permalink
- Content (filtered and truncated)
- Excerpt (if exists)
- Featured image URL + alt (if exists)
- Author name
- Publish date / modified date
- Site name + organization settings if available

### Output requirements

- Must be valid JSON.
- Allow either:
  - A single object
  - Or an array of objects / @graph
- Must include `"@context": "https://schema.org"`
- If it includes FAQPage, ensure content truly contains FAQs.

### Validation and sanitation

Backend must:
- JSON decode check.
- Enforce max size (eg 50 KB).
- Strip script tags and any non-JSON output.
- If model returns extra text, attempt to extract first valid JSON object/array.
- On failure: store error meta and return meaningful error to UI.

### Save

If force enabled or meta empty or hash differs:
- Update `_ai_jsonld_schema`
- Update timestamps, status, and hash

### Return

AJAX returns JSON:
```json
{
    "success": true,
    "schema": "...",
    "cached": false,
    "hash": "abc123...",
    "generated_at": 1234567890,
    "message": "..."
}
```

---

## 8. Frontend Injection

Two modes.

### Mode A: Output in head (recommended)

**Hook:**
```php
add_action('wp_head', ...)
```

**Logic:**
- If singular and post type enabled:
  - Fetch `_ai_jsonld_schema`
  - If exists and valid JSON:
    - Echo `<script type="application/ld+json">…</script>`

### Mode B: Append after content

**Hook:**
```php
add_filter('the_content', ...)
```

**Logic:**
- Only on singular main query, in loop.
- Append script tag at end of content.

**Important:**
- Even in "after content" mode, output should be a script tag, not visible JSON.

### Frontend Conflict Detection

**Setting:**
- `skip_if_schema_exists` (bool, default: false)

**Detection implementation:**
```php
function should_output_schema($post_id) {
    $settings = get_option('ai_jsonld_settings', []);

    $schema = get_post_meta($post_id, '_ai_jsonld_schema', true);
    if (empty($schema)) {
        return false;
    }

    if (empty($settings['skip_if_schema_exists'])) {
        return true;
    }

    // Check for Yoast SEO
    if (defined('WPSEO_VERSION')) {
        $yoast_schema = WPSEO_Options::get('disable-schema');
        if (!$yoast_schema) {
            return apply_filters('ai_jsonld_output_with_yoast', false, $post_id);
        }
    }

    // Check for RankMath
    if (class_exists('RankMath')) {
        $rm_schema = RankMath\Helper::get_settings('general.schema_enable');
        if ($rm_schema) {
            return apply_filters('ai_jsonld_output_with_rankmath', false, $post_id);
        }
    }

    return true;
}
```

**Developer filter:**
```php
$should_output = apply_filters('ai_jsonld_should_output', $should_output, $post_id);
```

**Admin notice:**
- If SEO plugin detected, show: "Yoast SEO detected. Enable 'Skip if schema exists' to prevent duplicate schema."

**Debug info:**
- Add HTML comment when skipping (if debug enabled): `<!-- AI JSON-LD: Skipped - existing schema detected (Yoast SEO) -->`

---

## 9. Provider Layer (Extensible Design)

Create an interface:

```php
interface ProviderInterface {
    public function get_name(): string;
    public function generate_schema(array $payload, array $settings): array;
    public function test_connection(array $settings): array;
}
```

**DeepSeek provider implementation:**
- `DeepSeekProvider` with:
  - Base URL constant
  - Headers with API key
  - Request/response mapping

**Future provider additions:**
- Add new class, register in provider registry.
- Settings page uses registry to build dropdown.

---

## 10. Security and Permissions

- Nonces for AJAX and settings.
- Capability checks:
  - Settings: `manage_options`
  - Generation: `current_user_can('edit_post', $post_id)`
- Sanitize:
  - All settings via `sanitize_text_field` / `absint` / `floatval`
- Escape output:
  - When printing JSON-LD, use `wp_json_encode` if storing decoded form, or print stored JSON carefully with no HTML escaping that would break JSON.
- Store API key encrypted. Never output full key.

---

## 11. Compatibility Considerations

- Gutenberg and Classic Editor
- Multisite (store settings per site unless you explicitly want network-level settings)
- Work alongside SEO plugins:
  - Provide toggle "Skip output if existing JSON-LD detected"

---

## 12. Logging and Debugging

If debug enabled:
- Log request IDs, errors, response parsing failures to `error_log`.
- Never log API key or full content.

---

## 13. Edge Cases

**Empty content:**
- Show warning and don't generate.

**Very long content:**
- Truncate to `max_content_chars` (default 8000) before sending.
- Prefer complete sentences.
- Include truncation indicator in prompt.

**Content updates after generation:**
- Show "⚠️ Content has changed" warning if content hash differs.

**Multiple schema blocks:**
- Allow arrays or `@graph` patterns.

**Rate limiting:**
- Implement exponential backoff (3 retries max).
- Per-post cooldown of 30 seconds.
- Global rate limit tracking via transient.

---

## 14. Acceptance Criteria

- Settings page saves provider + API key and can test connection.
- Metabox button generates schema and displays it.
- Schema is stored in post meta.
- Frontend outputs schema for that page only.
- JSON output is valid and includes schema.org context.
- Errors are visible in admin and don't break frontend.
- Cache works correctly (hash comparison, force regenerate option).
- Rate limiting prevents API abuse.

---

## 15. File Structure

```
ai-jsonld-generator/
├── ai-jsonld-generator.php          # Main plugin bootstrap
├── uninstall.php                     # Cleanup on uninstall
│
├── includes/
│   ├── class-admin.php              # Settings page, menu registration
│   ├── class-metabox.php            # Edit screen metabox
│   ├── class-ajax.php               # AJAX handlers
│   ├── class-schema-output.php      # Frontend wp_head/the_content injection
│   ├── class-schema-validator.php   # JSON validation and sanitization
│   ├── class-prompt-builder.php     # Builds prompts and payloads
│   ├── class-content-processor.php  # Content preparation and truncation
│   ├── class-encryption.php         # API key encryption/decryption
│   └── class-conflict-detector.php  # SEO plugin detection
│
├── providers/
│   ├── interface-provider.php       # Provider contract
│   ├── class-provider-registry.php  # Provider registration and lookup
│   ├── class-deepseek-provider.php  # DeepSeek implementation
│   └── class-abstract-provider.php  # Shared provider functionality
│
├── assets/
│   ├── js/
│   │   ├── admin.js                 # Settings page JS
│   │   └── metabox.js               # Metabox interactions
│   └── css/
│       ├── admin.css                # Settings page styles
│       └── metabox.css              # Metabox styles
│
└── languages/
    └── ai-jsonld-generator.pot      # Translation template
```

---

## 16. Practical Recommendations

1. **Put JSON-LD in the head by default.** It's the standard and avoids theme/content edge cases.

2. **Don't let the model invent facts.** The prompt should say: "If not present, omit."

3. **Validate hard.** If output isn't strict JSON, reject and show the raw response in debug mode.

4. **Cache aggressively.** Use content hash to avoid unnecessary API calls.

5. **Rate limit defensively.** Implement cooldowns to prevent accidental API bill spikes.

---

## 17. Future Enhancement: Bulk Generation (v1.1)

*Note: Not implemented in v1, but design should accommodate this.*

**Bulk action registration:**
```php
add_filter('bulk_actions-edit-page', function($actions) {
    $actions['generate_jsonld'] = 'Generate JSON-LD';
    return $actions;
});
```

**Handler design:**
- Accept array of post_ids
- Process sequentially with delay between requests
- Use background processing (`WP_Background_Process`) for large batches
- Store progress in transient for UI feedback

**UI considerations:**
- Show progress bar during bulk operation
- Allow cancellation
- Display summary: "Generated: X, Skipped (cached): Y, Failed: Z"

---

## 18. Uninstall and Cleanup

**uninstall.php:**
```php
<?php
/**
 * AI JSON-LD Generator Uninstall
 */

if (!defined('WP_UNINSTALL_PLUGIN')) {
    exit;
}

$settings = get_option('ai_jsonld_settings', []);
$delete_data = isset($settings['delete_data_on_uninstall']) ? $settings['delete_data_on_uninstall'] : false;

// Always delete plugin options
delete_option('ai_jsonld_settings');

// Delete transients
global $wpdb;
$wpdb->query(
    "DELETE FROM {$wpdb->options}
     WHERE option_name LIKE '_transient_ai_jsonld_%'
     OR option_name LIKE '_transient_timeout_ai_jsonld_%'"
);

// Conditionally delete post meta
if ($delete_data) {
    $wpdb->query(
        "DELETE FROM {$wpdb->postmeta}
         WHERE meta_key IN (
             '_ai_jsonld_schema',
             '_ai_jsonld_schema_last_generated',
             '_ai_jsonld_schema_status',
             '_ai_jsonld_schema_error',
             '_ai_jsonld_schema_hash',
             '_ai_jsonld_type_hint',
             '_ai_jsonld_detected_type'
         )"
    );
}

// Clear scheduled events
wp_clear_scheduled_hook('ai_jsonld_regenerate');
```

**Deactivation hook:**
```php
register_deactivation_hook(__FILE__, function() {
    global $wpdb;
    $wpdb->query(
        "DELETE FROM {$wpdb->options}
         WHERE option_name LIKE '_transient_ai_jsonld_%'
         OR option_name LIKE '_transient_timeout_ai_jsonld_%'"
    );

    wp_clear_scheduled_hook('ai_jsonld_regenerate');
});
```

**Multisite considerations:**
```php
if (is_multisite()) {
    $sites = get_sites(['fields' => 'ids']);
    foreach ($sites as $site_id) {
        switch_to_blog($site_id);
        delete_option('ai_jsonld_settings');
        // ... rest of cleanup
        restore_current_blog();
    }
}
```

---

## Appendix: Quick Reference

### Settings Array Keys
| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `provider` | string | `'deepseek'` | Active LLM provider |
| `deepseek_api_key` | string | `''` | Encrypted API key |
| `deepseek_model` | string | `'deepseek-chat'` | Model identifier |
| `temperature` | float | `0.2` | Generation temperature |
| `max_tokens` | int | `1200` | Max response tokens |
| `max_content_chars` | int | `8000` | Content truncation limit |
| `output_location` | string | `'head'` | `head` or `after_content` |
| `enabled_post_types` | array | `['page']` | Post types to enable |
| `auto_regenerate_on_update` | bool | `false` | Auto-regen on save |
| `skip_if_schema_exists` | bool | `false` | Skip if SEO plugin schema exists |
| `delete_data_on_uninstall` | bool | `false` | Delete schemas on uninstall |
| `debug_logging` | bool | `false` | Enable debug logging |
| `settings_version` | string | `'1.0'` | For cache invalidation |

### Post Meta Keys
| Key | Description |
|-----|-------------|
| `_ai_jsonld_schema` | Generated JSON-LD string |
| `_ai_jsonld_schema_last_generated` | Unix timestamp |
| `_ai_jsonld_schema_status` | `ok` or `error` |
| `_ai_jsonld_schema_error` | Last error message |
| `_ai_jsonld_schema_hash` | Content hash for cache |
| `_ai_jsonld_type_hint` | User's preferred type |
| `_ai_jsonld_detected_type` | Actual generated type |

### Hooks and Filters
| Hook/Filter | Description |
|-------------|-------------|
| `ai_jsonld_should_output` | Filter whether to output schema |
| `ai_jsonld_output_with_yoast` | Filter output when Yoast active |
| `ai_jsonld_output_with_rankmath` | Filter output when RankMath active |
| `ai_jsonld_regenerate` | Scheduled action for async regen |
