# WP AI SEO Schema Generator - Project Context

## Project Overview

This is a WordPress plugin called "WP AI SEO Schema Generator" that automatically generates schema.org JSON-LD structured data for WordPress pages using AI (supports DeepSeek and OpenAI providers).

**Plugin Details:**
- **Name:** WP AI SEO Schema Generator
- **Slug:** `wp-ai-seo-schema-generator`
- **Text Domain:** `wp-ai-seo-schema-generator`
- **Version:** 1.3.0

## Core Functionality

The plugin provides:
1. Settings page for configuring LLM provider, API keys, and generation parameters
2. Metabox on page edit screens with "Generate JSON-LD" button
3. AI-powered generation of appropriate schema.org structured data
4. Caching system to avoid unnecessary API calls
5. Frontend injection of JSON-LD (in `<head>` by default)

## Architecture

### File Structure
```
wp-ai-seo-schema-generator/
├── wp-ai-seo-schema-generator.php   # Main bootstrap
├── uninstall.php                     # Cleanup
├── includes/
│   ├── class-admin.php              # Settings page
│   ├── class-metabox.php            # Edit screen metabox
│   ├── class-ajax.php               # AJAX handlers
│   ├── class-schema-output.php      # Frontend injection
│   ├── class-schema-validator.php   # JSON validation
│   ├── class-schema-reference.php   # Schema.org type definitions (14 types)
│   ├── class-prompt-builder.php     # Prompt construction
│   ├── class-content-processor.php  # Content prep/truncation with structure preservation
│   ├── class-encryption.php         # API key security
│   └── class-conflict-detector.php  # SEO plugin detection
├── providers/
│   ├── interface-provider.php       # Provider contract
│   ├── class-provider-registry.php  # Provider management
│   ├── class-abstract-provider.php  # Shared functionality (HTTP, retry logic)
│   ├── class-deepseek-provider.php  # DeepSeek implementation
│   └── class-openai-provider.php    # OpenAI implementation (gpt-5-nano)
└── assets/
    ├── js/
    │   ├── admin.js
    │   └── metabox.js
    └── css/
        ├── admin.css
        └── metabox.css
```

### Key Design Patterns

**Provider Abstraction:**
- Interface-based design for multiple LLM providers
- Supported providers: DeepSeek, OpenAI (gpt-5-nano)
- Per-model configuration for token limits
- Easy to add more providers (Anthropic, etc.)

**Caching Strategy:**
- Content hash (SHA256) based on post content, title, excerpt, modified date, settings version
- Force regenerate option available
- Cache invalidation on content or settings changes

**Security:**
- API keys encrypted with AES-256-CBC using WordPress salts
- Nonce validation on all forms/AJAX
- Capability checks: `manage_options` for settings, `edit_post` for generation
- Never output full API keys (show: `sk-a1••••••••z9x2`)

## Data Storage

### Settings (wp_options: 'wp_ai_schema_settings')
Key settings include:
- `provider`: 'deepseek' | 'openai'
- `deepseek_api_key`: encrypted string
- `deepseek_model`: 'deepseek-chat'
- `openai_api_key`: encrypted string
- `openai_model`: 'gpt-5-nano'
- `temperature`: 0.2 (DeepSeek only; OpenAI gpt-5-nano doesn't support custom temperature)
- `output_location`: 'head' | 'after_content'
- `enabled_post_types`: ['page']
- `auto_regenerate_on_update`: false
- `skip_if_schema_exists`: false (SEO plugin compatibility)
- `delete_data_on_uninstall`: false
- `debug_logging`: false
- `settings_version`: '1.1' (for cache invalidation)

**Note:** Token limits (max_tokens, max_content_chars) are now per-model constants defined in each provider class, not user-configurable settings.

**Business Details (v1.2.0+):**
- `business_name`: Organization/business name
- `business_description`: Brief business description
- `business_logo`: URL to logo image
- `business_email`: Primary contact email
- `business_phone`: Primary contact phone (with country code)
- `business_founding_date`: When the business was founded
- `business_social_links`: Array of platform => URL pairs
- `business_locations`: Array of location objects (see below)

**Location Structure:**
```php
[
    'name'        => 'Main Office',
    'street'      => '123 Main St',
    'city'        => 'New York',
    'state'       => 'NY',
    'postal_code' => '10001',
    'country'     => 'USA',
    'phone'       => '+1-234-567-8900',
    'email'       => 'office@example.com',
    'hours'       => [
        'monday'    => '09:00-17:00',
        'tuesday'   => '09:00-17:00',
        // ... other days
    ]
]
```

### Post Meta
- `_wp_ai_schema_schema`: Generated JSON-LD string
- `_wp_ai_schema_schema_last_generated`: Unix timestamp
- `_wp_ai_schema_schema_status`: 'ok' | 'error'
- `_wp_ai_schema_schema_error`: Last error message
- `_wp_ai_schema_schema_hash`: Content hash for cache validation
- `_wp_ai_schema_type_hint`: User's preferred schema type
- `_wp_ai_schema_detected_type`: Actual type generated by LLM

## Content Processing

The plugin uses structure-preserving content processing to help the LLM understand page organization.

### Structure Preservation (v1.1.0+)

HTML semantic structure is converted to readable markers:

```
HTML Input:                          Processed Output:
<h2>Our Services</h2>        →       ## [Our Services] ##
<ul>                         →       [LIST START]
  <li>Web Development</li>   →       - Web Development
  <li>Security</li>          →       - Security
</ul>                        →       [LIST END]
<section>...</section>       →       [SECTION]...[/SECTION]
<strong>text</strong>        →       **text**
<a href="url">text</a>       →       text (url)  [if mailto/tel/https]
```

This helps the LLM identify:
- Services (under "Services", "What We Do" headings)
- Contact info (under "Contact" sections)
- Team members (under "Team", "About Us")
- FAQs (Question/Answer patterns)

### Processing Steps

1. Remove scripts, styles, comments, iframes, forms
2. Convert headings to `## [Heading] ##` markers
3. Convert lists to `- item` format with `[LIST START/END]`
4. Convert semantic sections to markers
5. Preserve emphasis (`**bold**`, `*italic*`)
6. Extract useful links (mailto:, tel:, https://)
7. Strip remaining HTML
8. Decode entities and normalize whitespace

### Truncation Logic
- Default max: 50,000 characters
- Intelligent truncation at sentence boundaries (. ? !)
- Must be > 70% of max_chars to break at sentence
- Truncation indicator added to prompt

## Schema Reference System (v1.1.0+)

The plugin includes a comprehensive schema.org reference that guides the LLM on available properties.

### Supported Schema Types (14 total)

| Type | Description |
|------|-------------|
| Organization | Companies, businesses, institutions |
| LocalBusiness | Businesses with physical locations |
| Service | Services offered by organizations |
| Product | Products for sale |
| Person | Individual people |
| Event | Events with dates/locations |
| FAQPage | Pages with Q&A content |
| Article | Blog posts, news articles |
| WebPage | Generic web pages |
| HowTo | Step-by-step instructions |
| ContactPoint | Contact information |
| PostalAddress | Physical addresses |
| Offer | Pricing and availability |
| Review | User reviews and ratings |

### Dynamic Type Selection

Based on the type hint, relevant schema types are included in the prompt:

- `auto` → WebPage, Article, Service, LocalBusiness, FAQPage, Organization + supporting types
- `LocalBusiness` → LocalBusiness, ContactPoint, PostalAddress, Offer, Review
- `Service` → Service, Organization, ContactPoint, Offer
- etc.

This keeps the prompt focused and within token limits (~1,500 extra tokens for standard reference).

### @graph and @id References

The LLM is guided to use linked entities:

```json
{
  "@context": "https://schema.org",
  "@graph": [
    {"@type": "Organization", "@id": "#organization", "name": "..."},
    {"@type": "Service", "provider": {"@id": "#organization"}}
  ]
}
```

## Business Details (v1.2.0+)

The plugin allows site owners to provide verified business information that takes precedence over content extracted by the LLM. This ensures accurate Organization, LocalBusiness, and ContactPoint schemas.

### Configuration

In **Settings → AI JSON-LD → Business Details**:

**Basic Information:**
- Business/Organization Name
- Description
- Logo URL
- Primary Email
- Primary Phone (with country code)
- Founding Date

**Social Links:**
Pre-defined fields for major platforms:
- Facebook, Twitter/X, LinkedIn, Instagram
- YouTube, TikTok, Pinterest, GitHub

**Locations (Repeater):**
Support for multiple business locations, each with:
- Location name (e.g., "Main Office", "Downtown Branch")
- Full address (street, city, state, postal code, country)
- Location-specific phone and email
- Opening hours for each day of the week

### How It Works

1. Business data is configured once in plugin settings (global)
2. When generating schema, the data is passed to the LLM as `BUSINESS DATA`
3. The LLM is instructed to use this verified data for Organization/LocalBusiness schemas
4. Business data takes precedence over information extracted from page content

### Example Output

With business details configured, the generated schema includes:

```json
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": "#organization",
      "name": "Acme Corp",
      "description": "Leading provider of widgets",
      "logo": "https://example.com/logo.png",
      "email": "info@example.com",
      "telephone": "+1-234-567-8900",
      "foundingDate": "2010-01-15",
      "sameAs": [
        "https://facebook.com/acme",
        "https://linkedin.com/company/acme"
      ]
    },
    {
      "@type": "LocalBusiness",
      "@id": "#location-main",
      "name": "Acme Corp - Main Office",
      "parentOrganization": {"@id": "#organization"},
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "123 Main St",
        "addressLocality": "New York",
        "addressRegion": "NY",
        "postalCode": "10001",
        "addressCountry": "USA"
      },
      "openingHoursSpecification": [...]
    }
  ]
}
```

## Rate Limiting & Retry

**Retry Configuration:**
- Max retries: 3
- Base delay: 1000ms
- Max delay: 10000ms
- Backoff multiplier: 2
- Retryable status codes: 429, 500, 502, 503, 504
- Respects `Retry-After` header

**Cooldowns:**
- Per-post: 30 seconds (transient: `wp_ai_schema_cooldown_{$post_id}`)
- Global rate limit tracking: `wp_ai_schema_rate_limit_until`

## Prompt Engineering

**System Prompt Principles:**
- Output ONLY valid JSON (no markdown, no explanations)
- NEVER invent/hallucinate information
- Omit fields if data not provided
- Support both single objects and @graph arrays
- Accuracy over completeness

**Schema Types Supported:**
- Article, WebPage, Service, LocalBusiness, FAQPage, Product, Organization, Person, Event, HowTo
- Auto-detection recommended
- User can provide type hints

**Payload Includes:**
- Page data: title, URL, content, excerpt, author, dates, featured image, categories, tags
- Site data: name, URL, description
- Type hint (if not 'auto')

## Frontend Output

**Default Mode (recommended):**
- Hook: `wp_head`
- Output: `<script type="application/ld+json">...</script>` in `<head>`

**Alternative Mode:**
- Hook: `the_content` filter
- Output: Script tag appended after content

**Conflict Detection:**
- Can detect Yoast SEO and RankMath
- Optional setting to skip output if SEO plugin schema exists
- Filter: `wp_ai_schema_should_output` for custom control

## Important Implementation Notes

1. **WordPress Standards:**
   - Use WordPress Settings API for options page
   - Proper nonce and capability checks
   - Internationalization ready (text domain: 'wp-ai-seo-schema-generator')
   - Compatible with Classic Editor and Gutenberg

2. **JSON Validation:**
   - Must be valid JSON-decodable
   - Max size limit: 50 KB
   - Strip script tags and non-JSON content
   - Attempt to extract first valid JSON if model returns extra text

3. **Error Handling:**
   - Store errors in post meta
   - Display user-friendly messages in metabox
   - Never break frontend on errors
   - Optional debug logging (no API keys or full content)

4. **SEO Plugin Compatibility:**
   - Designed to work alongside Yoast, RankMath, etc.
   - Optional toggle to prevent duplicate schema
   - Admin notices if conflicts detected

5. **Multisite Support:**
   - Settings stored per-site
   - Cleanup handles multisite uninstall

## Development Priorities

**Must Have (v1):**
- ✓ Settings page with DeepSeek provider
- ✓ Encrypted API key storage
- ✓ Metabox on page edit screen
- ✓ Content processing and truncation
- ✓ Cache system with hash validation
- ✓ Rate limiting and retry logic
- ✓ Frontend output in head
- ✓ JSON validation
- ✓ Basic error handling

**Nice to Have (v1.1+):**
- Bulk generation for multiple pages
- Support for custom post types
- Additional LLM providers
- Schema validation against schema.org
- Analytics/usage tracking

## Testing Checklist

When implementing, ensure:
- [ ] Settings save correctly and API key is encrypted
- [ ] Test connection button works
- [ ] Metabox appears on page edit screen
- [ ] Generate button creates valid JSON-LD
- [ ] Preview shows generated schema
- [ ] Schema saves to post meta
- [ ] Frontend outputs schema in head
- [ ] Cache prevents regeneration when content unchanged
- [ ] Force regenerate option works
- [ ] Content truncation works correctly
- [ ] Rate limiting prevents abuse
- [ ] Error states display properly
- [ ] Uninstall cleanup works (when option enabled)

## Code Conventions

- Use WordPress coding standards
- Class names: `class-name-with-hyphens.php`
- Class structure: `Class_Name_With_Underscores`
- Prefix all functions/classes with plugin slug
- Sanitize inputs, escape outputs
- Validate and sanitize JSON carefully
- Use WordPress nonces for security
- Check capabilities before operations

## API Reference

**DeepSeek API:**
- Endpoint: https://api.deepseek.com/v1/chat/completions
- Model: deepseek-chat
- Authentication: Bearer token in header
- Request format: OpenAI-compatible
- Supports: temperature parameter

**OpenAI API:**
- Endpoint: https://api.openai.com/v1/chat/completions
- Model: gpt-5-nano
- Authentication: Bearer token in header
- Uses `max_completion_tokens` (not `max_tokens`)
- Note: gpt-5-nano is a reasoning model (uses internal reasoning tokens)
- Note: Does NOT support temperature parameter (only default of 1)

## Token Management

Understanding how tokens work is important for the plugin's architecture.

### Per-Model Configuration (v1.3.0+)

Token limits are now defined per-model in each provider class. This allows optimal configuration for each model's capabilities.

**To modify limits**, edit the `MODELS` constant in the provider class:
- DeepSeek: `providers/class-deepseek-provider.php`
- OpenAI: `providers/class-openai-provider.php`

```php
const MODELS = array(
    'model-name' => array(
        'name'              => 'Display Name',
        'context_window'    => 65536,    // Total context (input + output)
        'max_output'        => 8000,     // Model's hard max output limit
        'max_content_chars' => 50000,    // Max page content to send
    ),
);
```

### Model Specifications (Researched)

| Model | Context Window | Max Output | Max Content Chars |
|-------|---------------|------------|-------------------|
| **deepseek-chat** | 65,536 | 8,000 | 50,000 |
| **gpt-5-nano** | 400,000 | 128,000 | 200,000 |

### Token Types

1. **Input Tokens** - What we send to the LLM:
   - System prompt (~2,000-3,000 tokens)
   - Schema.org reference (~500-1,500 tokens depending on type hint)
   - Page content (varies by page size)
   - Site data and metadata (~100-200 tokens)

2. **Output Tokens** - What the LLM returns:
   - The generated JSON-LD schema
   - For reasoning models (gpt-5-nano): includes internal reasoning tokens

### Dynamic Token Calculation

The plugin requests the model's full `max_output` and calculates safe limits:

```
Available Output = Context Window - Input Tokens - Safety Buffer (2K)
Actual Max Tokens = min(max_output, available_output)
```

**Token Estimation:**
- ~3.5 characters per token (conservative for mixed content)
- 50,000 chars ≈ ~14,000 tokens

### Reasoning Model Support (OpenAI gpt-5-nano)

OpenAI's gpt-5-nano is a reasoning model that uses internal "thinking" tokens:
- Reasoning tokens count against `max_completion_tokens`
- Simple tasks may use ~64 reasoning tokens
- Complex schema generation uses ~1,700+ reasoning tokens
- **MIN_OUTPUT_TOKENS** set to 4,000 to ensure useful output

**Note:** gpt-5-nano doesn't support custom temperature (only default of 1).

### Safety Features

1. **Minimum Output Guarantee**:
   - DeepSeek: 1,000 tokens minimum
   - OpenAI: 4,000 tokens minimum (for reasoning overhead)
2. **Safety Buffer**: 2,000 tokens reserved for estimation errors
3. **Warning Logging**: Logs warning if input is too large (when debug enabled)

### When Content is Too Large

If a page exceeds the context window:
1. Content is truncated at `max_content_chars`
2. Truncation happens at sentence boundaries when possible
3. A truncation indicator is added to the prompt
4. The LLM generates schema based on available content

## Hooks & Filters Available

```php
// Filter whether to output schema
apply_filters('wp_ai_schema_should_output', $should_output, $post_id);

// Filter output with Yoast active
apply_filters('wp_ai_schema_output_with_yoast', false, $post_id);

// Filter output with RankMath active
apply_filters('wp_ai_schema_output_with_rankmath', false, $post_id);

// Scheduled action for async regeneration
do_action('wp_ai_schema_regenerate', $post_id);
```

## Security Notes

- **Never log:** API keys, full content
- **Always validate:** User capabilities, nonces, post ownership
- **Sanitize:** All settings inputs
- **Escape:** All outputs (except JSON-LD which must remain valid JSON)
- **Encrypt:** API keys using AES-256-CBC with WordPress salts
- **Validate:** JSON structure and size before saving

## Current Status

**Version 1.3.0** - Plugin is fully implemented and functional.

### Implemented Features:
- **Multi-provider support**: DeepSeek and OpenAI (gpt-5-nano)
- **Per-model token configuration**: Each model defines its own limits
- HTML structure preservation for better content understanding
- Comprehensive schema.org reference (14 types)
- Dynamic token management to prevent context overflow
- Reasoning model support (OpenAI gpt-5-nano)
- Encrypted API key storage (AES-256-CBC)
- Caching with content hash validation (includes provider/model)
- Rate limiting and retry logic
- SEO plugin conflict detection
- Frontend schema output in `<head>`
- **Business Details configuration** (v1.2.0):
  - Structured fields for organization info
  - Multiple location support with addresses and hours
  - Social media profile links
  - Business data takes precedence in schema generation

### v1.3.0 Changes:
- Added OpenAI provider support (gpt-5-nano model)
- Per-model token limits (context_window, max_output, max_content_chars)
- Researched and corrected actual model limits
- Support for reasoning models (internal thinking tokens)
- Cache invalidation on provider/model switch
- Removed user-configurable max_tokens/max_content_chars (now per-model)
