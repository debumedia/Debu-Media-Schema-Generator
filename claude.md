# AI JSON-LD Generator - Project Context

## Project Overview

This is a WordPress plugin called "AI JSON-LD Generator" that automatically generates schema.org JSON-LD structured data for WordPress pages using AI (LLM providers starting with DeepSeek).

**Plugin Details:**
- **Name:** AI JSON-LD Generator
- **Slug:** `ai-jsonld-generator`
- **Text Domain:** `ai-jsonld-generator`
- **Version:** 1.0 (initial)

## Core Functionality

The plugin provides:
1. Settings page for configuring LLM provider, API keys, and generation parameters
2. Metabox on page edit screens with "Generate JSON-LD" button
3. AI-powered generation of appropriate schema.org structured data
4. Caching system to avoid unnecessary API calls
5. Frontend injection of JSON-LD (in `<head>` by default)

## Architecture

### File Structure
```
ai-jsonld-generator/
├── ai-jsonld-generator.php          # Main bootstrap
├── uninstall.php                     # Cleanup
├── includes/
│   ├── class-admin.php              # Settings page
│   ├── class-metabox.php            # Edit screen metabox
│   ├── class-ajax.php               # AJAX handlers
│   ├── class-schema-output.php      # Frontend injection
│   ├── class-schema-validator.php   # JSON validation
│   ├── class-prompt-builder.php     # Prompt construction
│   ├── class-content-processor.php  # Content prep/truncation
│   ├── class-encryption.php         # API key security
│   └── class-conflict-detector.php  # SEO plugin detection
├── providers/
│   ├── interface-provider.php       # Provider contract
│   ├── class-provider-registry.php  # Provider management
│   ├── class-deepseek-provider.php  # DeepSeek implementation
│   └── class-abstract-provider.php  # Shared functionality
└── assets/
    ├── js/
    │   ├── admin.js
    │   └── metabox.js
    └── css/
        ├── admin.css
        └── metabox.css
```

### Key Design Patterns

**Provider Abstraction:**
- Interface-based design for multiple LLM providers
- v1 implements DeepSeek only
- Easy to add OpenAI, Anthropic, etc. later

**Caching Strategy:**
- Content hash (SHA256) based on post content, title, excerpt, modified date, settings version
- Force regenerate option available
- Cache invalidation on content or settings changes

**Security:**
- API keys encrypted with AES-256-CBC using WordPress salts
- Nonce validation on all forms/AJAX
- Capability checks: `manage_options` for settings, `edit_post` for generation
- Never output full API keys (show: `sk-a1••••••••z9x2`)

## Data Storage

### Settings (wp_options: 'ai_jsonld_settings')
Key settings include:
- `provider`: 'deepseek' (v1)
- `deepseek_api_key`: encrypted string
- `deepseek_model`: 'deepseek-chat'
- `temperature`: 0.2
- `max_tokens`: 1200
- `max_content_chars`: 8000
- `output_location`: 'head' | 'after_content'
- `enabled_post_types`: ['page']
- `auto_regenerate_on_update`: false
- `skip_if_schema_exists`: false (SEO plugin compatibility)
- `delete_data_on_uninstall`: false
- `debug_logging`: false
- `settings_version`: '1.0' (for cache invalidation)

### Post Meta
- `_ai_jsonld_schema`: Generated JSON-LD string
- `_ai_jsonld_schema_last_generated`: Unix timestamp
- `_ai_jsonld_schema_status`: 'ok' | 'error'
- `_ai_jsonld_schema_error`: Last error message
- `_ai_jsonld_schema_hash`: Content hash for cache validation
- `_ai_jsonld_type_hint`: User's preferred schema type
- `_ai_jsonld_detected_type`: Actual type generated by LLM

## Content Processing

**Preparation Steps:**
1. Strip HTML tags: `wp_strip_all_tags($content)`
2. Decode entities: `html_entity_decode($content, ENT_QUOTES, 'UTF-8')`
3. Normalize whitespace: `preg_replace('/\s+/', ' ', $content)`
4. Trim: `trim($content)`

**Truncation Logic:**
- Default max: 8000 characters
- Intelligent truncation at sentence boundaries (. ? !)
- Must be > 70% of max_chars to break at sentence
- Truncation indicator added to prompt

## Rate Limiting & Retry

**Retry Configuration:**
- Max retries: 3
- Base delay: 1000ms
- Max delay: 10000ms
- Backoff multiplier: 2
- Retryable status codes: 429, 500, 502, 503, 504
- Respects `Retry-After` header

**Cooldowns:**
- Per-post: 30 seconds (transient: `ai_jsonld_cooldown_{$post_id}`)
- Global rate limit tracking: `ai_jsonld_rate_limit_until`

## Prompt Engineering

**System Prompt Principles:**
- Output ONLY valid JSON (no markdown, no explanations)
- NEVER invent/hallucinate information
- Omit fields if data not provided
- Support both single objects and @graph arrays
- Accuracy over completeness

**Schema Types Supported:**
- Article, WebPage, Service, LocalBusiness, FAQPage, Product, Organization, Person, Event, HowTo
- Auto-detection recommended
- User can provide type hints

**Payload Includes:**
- Page data: title, URL, content, excerpt, author, dates, featured image, categories, tags
- Site data: name, URL, description
- Type hint (if not 'auto')

## Frontend Output

**Default Mode (recommended):**
- Hook: `wp_head`
- Output: `<script type="application/ld+json">...</script>` in `<head>`

**Alternative Mode:**
- Hook: `the_content` filter
- Output: Script tag appended after content

**Conflict Detection:**
- Can detect Yoast SEO and RankMath
- Optional setting to skip output if SEO plugin schema exists
- Filter: `ai_jsonld_should_output` for custom control

## Important Implementation Notes

1. **WordPress Standards:**
   - Use WordPress Settings API for options page
   - Proper nonce and capability checks
   - Internationalization ready (text domain: 'ai-jsonld-generator')
   - Compatible with Classic Editor and Gutenberg

2. **JSON Validation:**
   - Must be valid JSON-decodable
   - Max size limit: 50 KB
   - Strip script tags and non-JSON content
   - Attempt to extract first valid JSON if model returns extra text

3. **Error Handling:**
   - Store errors in post meta
   - Display user-friendly messages in metabox
   - Never break frontend on errors
   - Optional debug logging (no API keys or full content)

4. **SEO Plugin Compatibility:**
   - Designed to work alongside Yoast, RankMath, etc.
   - Optional toggle to prevent duplicate schema
   - Admin notices if conflicts detected

5. **Multisite Support:**
   - Settings stored per-site
   - Cleanup handles multisite uninstall

## Development Priorities

**Must Have (v1):**
- ✓ Settings page with DeepSeek provider
- ✓ Encrypted API key storage
- ✓ Metabox on page edit screen
- ✓ Content processing and truncation
- ✓ Cache system with hash validation
- ✓ Rate limiting and retry logic
- ✓ Frontend output in head
- ✓ JSON validation
- ✓ Basic error handling

**Nice to Have (v1.1+):**
- Bulk generation for multiple pages
- Support for custom post types
- Additional LLM providers
- Schema validation against schema.org
- Analytics/usage tracking

## Testing Checklist

When implementing, ensure:
- [ ] Settings save correctly and API key is encrypted
- [ ] Test connection button works
- [ ] Metabox appears on page edit screen
- [ ] Generate button creates valid JSON-LD
- [ ] Preview shows generated schema
- [ ] Schema saves to post meta
- [ ] Frontend outputs schema in head
- [ ] Cache prevents regeneration when content unchanged
- [ ] Force regenerate option works
- [ ] Content truncation works correctly
- [ ] Rate limiting prevents abuse
- [ ] Error states display properly
- [ ] Uninstall cleanup works (when option enabled)

## Code Conventions

- Use WordPress coding standards
- Class names: `class-name-with-hyphens.php`
- Class structure: `Class_Name_With_Underscores`
- Prefix all functions/classes with plugin slug
- Sanitize inputs, escape outputs
- Validate and sanitize JSON carefully
- Use WordPress nonces for security
- Check capabilities before operations

## API Reference

**DeepSeek API:**
- Endpoint: https://api.deepseek.com/v1/chat/completions
- Model: deepseek-chat
- Authentication: Bearer token in header
- Request format: OpenAI-compatible

## Token Management

Understanding how tokens work is important for configuring the plugin correctly.

### Token Types

1. **Input Tokens** - What we send to the LLM:
   - System prompt (~2,000-3,000 tokens)
   - Schema.org reference (~500-1,500 tokens depending on type hint)
   - Page content (varies by page size)
   - Site data and metadata (~100-200 tokens)

2. **Output Tokens** - What the LLM returns:
   - The generated JSON-LD schema
   - Controlled by `max_tokens` setting

### Context Window

DeepSeek-chat has a **64,000 token context window**. This is the total limit for input + output combined.

```
Context Window (64K) = Input Tokens + Output Tokens
```

### Settings

| Setting | Default | Description |
|---------|---------|-------------|
| `max_tokens` | 8000 | Maximum tokens for LLM response (JSON-LD output) |
| `max_content_chars` | 50000 | Maximum characters of page content to process |

### Dynamic Token Calculation

The plugin automatically calculates safe output tokens to prevent exceeding the context window:

```
Available Output = Context Window (64K) - Input Tokens - Safety Buffer (2K)
Actual Max Tokens = min(requested_max_tokens, available_output, model_max_8192)
```

**Token Estimation:**
- ~3.5 characters per token (conservative for mixed content)
- 50,000 chars ≈ ~14,000 tokens

**Example Calculation:**
- System prompt + reference: ~3,000 tokens
- Page content (30K chars): ~8,500 tokens
- Overhead: ~500 tokens
- **Total input: ~12,000 tokens**
- **Available for output: 64,000 - 12,000 - 2,000 = 50,000 tokens**
- **Actual max_tokens: min(8000, 50000, 8192) = 8000**

### Safety Features

1. **Minimum Output Guarantee**: Always reserves at least 1,000 tokens for output
2. **Safety Buffer**: 2,000 tokens reserved to account for estimation errors
3. **Warning Logging**: Logs a warning if input is too large (when debug enabled)

### When Content is Too Large

If a page exceeds the context window:
1. Content is truncated at `max_content_chars` (50,000 chars)
2. Truncation happens at sentence boundaries when possible
3. A truncation indicator is added to the prompt
4. The LLM generates schema based on available content

For extremely large pages, consider:
- Reducing `max_content_chars` in settings
- Breaking content into separate pages
- Using excerpts/summaries for very long content

## Hooks & Filters Available

```php
// Filter whether to output schema
apply_filters('ai_jsonld_should_output', $should_output, $post_id);

// Filter output with Yoast active
apply_filters('ai_jsonld_output_with_yoast', false, $post_id);

// Filter output with RankMath active
apply_filters('ai_jsonld_output_with_rankmath', false, $post_id);

// Scheduled action for async regeneration
do_action('ai_jsonld_regenerate', $post_id);
```

## Security Notes

- **Never log:** API keys, full content
- **Always validate:** User capabilities, nonces, post ownership
- **Sanitize:** All settings inputs
- **Escape:** All outputs (except JSON-LD which must remain valid JSON)
- **Encrypt:** API keys using AES-256-CBC with WordPress salts
- **Validate:** JSON structure and size before saving

## Current Status

**Version 1.1.1** - Plugin is fully implemented and functional.

### Implemented Features:
- DeepSeek LLM integration with comprehensive prompts
- HTML structure preservation for better content understanding
- Comprehensive schema.org reference (14 types)
- Dynamic token management to prevent context overflow
- Encrypted API key storage (AES-256-CBC)
- Caching with content hash validation
- Rate limiting and retry logic
- SEO plugin conflict detection
- Frontend schema output in `<head>`
